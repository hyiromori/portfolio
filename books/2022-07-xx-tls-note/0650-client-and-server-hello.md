---
title: "Client Hello と Server Hello の中身を考察する"
---

https://www.google.co.jp/ に Google Chrome 103 でアクセスした際のパケットを [Wireshark](https://www.wireshark.org/) でキャプチャしてみた結果を考察してみました。

# Client Hello

## パケットの内容

```
Frame 1: 659 bytes on wire (5272 bits), 659 bytes captured (5272 bits) on interface en0, id 0
Ethernet II, Src: Apple_0c:aa:a1 (bc:d0:74:0c:aa:a1), Dst: ASUSTekC_9d:ea:20 (04:d9:f5:9d:ea:20)
Internet Protocol Version 4, Src: 192.168.50.247, Dst: 172.217.175.110
Transmission Control Protocol, Src Port: 57705, Dst Port: 443, Seq: 1, Ack: 1, Len: 593
Transport Layer Security
    TLSv1.3 Record Layer: Handshake Protocol: Client Hello
        Content Type: Handshake (22)
        Version: TLS 1.0 (0x0301)
        Length: 588
        Handshake Protocol: Client Hello
            Handshake Type: Client Hello (1)
            Length: 584
            Version: TLS 1.2 (0x0303)
            Random: 87f4080f12c00236ae32a3cbd4a5050e270a62f8b3aca6debaf68d846de6da48
            Session ID Length: 32
            Session ID: 3620f74083bab3ab079abe6f6476ff29ffa3897b32b4e700202ff090ce7c21ff
            Cipher Suites Length: 32
            Cipher Suites (16 suites)
                Cipher Suite: Reserved (GREASE) (0xfafa)
                Cipher Suite: TLS_AES_128_GCM_SHA256 (0x1301)
                Cipher Suite: TLS_AES_256_GCM_SHA384 (0x1302)
                Cipher Suite: TLS_CHACHA20_POLY1305_SHA256 (0x1303)
                Cipher Suite: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256 (0xc02b)
                Cipher Suite: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 (0xc02f)
                Cipher Suite: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384 (0xc02c)
                Cipher Suite: TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 (0xc030)
                Cipher Suite: TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256 (0xcca9)
                Cipher Suite: TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256 (0xcca8)
                Cipher Suite: TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA (0xc013)
                Cipher Suite: TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA (0xc014)
                Cipher Suite: TLS_RSA_WITH_AES_128_GCM_SHA256 (0x009c)
                Cipher Suite: TLS_RSA_WITH_AES_256_GCM_SHA384 (0x009d)
                Cipher Suite: TLS_RSA_WITH_AES_128_CBC_SHA (0x002f)
                Cipher Suite: TLS_RSA_WITH_AES_256_CBC_SHA (0x0035)
            Compression Methods Length: 1
            Compression Methods (1 method)
            Extensions Length: 479
            Extension: Reserved (GREASE) (len=0)
            Extension: server_name (len=21)
            Extension: extended_master_secret (len=0)
            Extension: renegotiation_info (len=1)
            Extension: supported_groups (len=10)
            Extension: ec_point_formats (len=2)
            Extension: session_ticket (len=0)
            Extension: application_layer_protocol_negotiation (len=14)
            Extension: status_request (len=5)
            Extension: signature_algorithms (len=18)
            Extension: signed_certificate_timestamp (len=0)
            Extension: key_share (len=43)
            Extension: psk_key_exchange_modes (len=2)
            Extension: supported_versions (len=7)
            Extension: compress_certificate (len=3)
            Extension: application_settings (len=5)
            Extension: Reserved (GREASE) (len=1)
            Extension: pre_shared_key (len=275)
            [JA3 Fullstring: 771,4865-4866-4867-49195-49199-49196-49200-52393-52392-49171-49172-156-157-47-53,0-23-65281-10-11-35-16-5-13-18-51-45-43-27-17513-41,29-23-24,0]
            [JA3: 598872011444709307b861ae817a4b60]
```

## 考察

### Version

値が `TLS 1.0 (0x0301)` に設定されています。

これは、ファイヤーウォールのようなミドルボックスによってトラフィックが破棄されることを防ぐため対策のようです。
TLS.1.3 ではこのフィールドは使われていません。
(詳細は「プロフェッショナルSSL/TLS PDF版 付録A P491」参照)

RFC 8446 でも `ProtocolVersion: legacy_version = 0x0303` と定義されています。

> struct {
>   ProtocolVersion legacy_version = 0x0303;    /* TLS v1.2 */
>   Random random;
> ...
> 
> https://datatracker.ietf.org/doc/html/rfc8446#section-4.1.2

`legacy_version` の説明には `TLS 1.2 (0x0303)` を設定されなければならない (MUST) と書かれています。

> legacy_version: (中略) In TLS 1.3, the client indicates its version preferences in the "supported_versions" extension (Section 4.2.1) and the legacy_version field MUST be set to 0x0303, which is the version number for TLS 1.2. TLS 1.3 ClientHellos are identified as having a legacy_version of 0x0303 and a supported_versions extension present with 0x0304 as the highest version indicated therein.
> (See Appendix D for details about backward compatibility.)
> 
> https://datatracker.ietf.org/doc/html/rfc8446#section-4.1.2

ただし ClientHello については、と完成の目的のため `TLS 1.0 (0x0301)` にしても良い (MAY) と書かれているので、Google Chrome は `TLS 1.0 (0x0301)` としているようです。

> legacy_record_version:  MUST be set to 0x0303 for all records generated by a TLS 1.3 implementation other than an initial ClientHello (i.e., one not generated after a HelloRetryRequest), where it MAY also be 0x0301 for compatibility purposes.
> 
> https://datatracker.ietf.org/doc/html/rfc8446#section-5.1

# Server Hello

## パケットの内容

```
Transport Layer Security
    TLSv1.3 Record Layer: Handshake Protocol: Server Hello
        Content Type: Handshake (22)
        Version: TLS 1.2 (0x0303)
        Length: 128
        Handshake Protocol: Server Hello
            Handshake Type: Server Hello (2)
            Length: 124
            Version: TLS 1.2 (0x0303)
            Random: 361f8dd6592a64415bc8c63bea1de10205573b4eba71f6ba19e51c31cb61dee4
            Session ID Length: 32
            Session ID: 3620f74083bab3ab079abe6f6476ff29ffa3897b32b4e700202ff090ce7c21ff
            Cipher Suite: TLS_AES_128_GCM_SHA256 (0x1301)
            Compression Method: null (0)
            Extensions Length: 52
            Extension: pre_shared_key (len=2)
                Type: pre_shared_key (41)
                Length: 2
                Pre-Shared Key extension
            Extension: key_share (len=36)
                Type: key_share (51)
                Length: 36
                Key Share extension
            Extension: supported_versions (len=2)
                Type: supported_versions (43)
                Length: 2
                Supported Version: TLS 1.3 (0x0304)
            [JA3S Fullstring: 771,4865,41-51-43]
            [JA3S: 2b0648ab686ee45e0e7c35fcfb0eea7e]
    TLSv1.3 Record Layer: Change Cipher Spec Protocol: Change Cipher Spec
        Content Type: Change Cipher Spec (20)
        Version: TLS 1.2 (0x0303)
        Length: 1
        Change Cipher Spec Message
    TLSv1.3 Record Layer: Application Data Protocol: http-over-tls
        Opaque Type: Application Data (23)
        Version: TLS 1.2 (0x0303)
        Length: 68
        Encrypted Application Data: fd4cee13e6519225b320e9e2d69f2b5d5f404a2195871798540020f63d1729280ef43732…
        [Application Data Protocol: http-over-tls]
```
