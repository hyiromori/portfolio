---
title: "ハンドシェイク"
---

ハンドシェイクとは、暗号化された通信を行うために必要な情報を交換し、暗号化通信を確立するための一連の処理です。
TLS 1.3 では、フルハンドシェイクと事前共有鍵 (PSK: Pre-Shared Key) 接続の２種類があります。

ハンドシェイクでは、以下の４つを達成する必要があります。

> 達成すべきことは4つあります。
>
> 1. 接続で使いたいパラメータを双方が提示し、一般的なセキュリティパラメータについて双方で合意する
> 2. サーバの真正性を検証する（必要であればクライアントの真正性も検証する）
> 3. 暗号鍵をいくつか生成する
> 4. ハンドシェイクメッセージが能動的ネットワーク攻撃者によって書き換えられていないことを検証する
>
> プロフェッショナルSSL/TLS 特別版PDF P495

# フルハンドシェイクの流れ

1. `[Client --> Server]` Client Hello
    - TLS 接続の要求
        - 接続したい TLS のバージョン
        - クライアントが使用できる暗号スイート一覧
        - (TLS 1.3 のみ) 鍵合意のパラメーター一式
2. `[Client <-- Server]` Server Hello
    - サーバー側が選択した暗号スイート
3. `[Client <-- Server]` Encrypted Extensions
4. `[Client <-- Server]` Certificate
5. `[Client <-- Server]` Certificate Verify
6. `[Client <-- Server]` Finished
7. `[Client <-- Server]` Finished (ハンドシェイク完了)
8. `[Client <-> Server]` Application Data
    - 双方向にアプリケーションデータをやり取りする
9. `[Client <-- Server]` Alert (Close Notify)
10. `[Client --> Server]` Alert (Close Notify) (接続終了)

- [TLS 1.3の性能 その2 – フルハンドシェイク - wolfSSL](https://www.wolfssl.jp/wolfblog/2018/06/01/tls-1-3performance2/)

# 事前共有鍵 (PSK: Pre-Shared Key) 接続の流れ

文字通り、事前に共有した鍵 (PSK) を使用して暗号通信を開始する方式。

PSK をそのまま使用することも可能。
しかし前方秘匿性 (PFS) がなくなるため、PSK を使ってさらにディフィー・ヘルマン鍵交換を実行することが推奨されている。

(筆者感想)
PSK を使ってもディフィー・ヘルマン鍵交換を行うのであれば、フルハンドシェイクと近い流れになるので、事前共有鍵のメンテナンスコストに対するメリットが低そうに思えた。

## セッション再開

> TLS 1.3 では、セッション再開は PSK の拡張として整理されており、再開時のプロトコルは PSK プロトコル利用の一方法として位置づけられています。
> 
> 徹底解剖 TLS 1.3 P33

セッションを再開する場合、前回の通信でサーバーから発行されたセッションチケットを送付することで開始する。

TLS 1.2 ではセッションIDを使った方式もあったが、TLS 1.3 では廃止された。
また TLS 1.2 ではクライアント側からセッションチケットの発行を要求できたが、TLS 1.3 ではサーバー側の判断担った。

## Early Data

PSK (そのまま鍵として使用する場合) やセッション再開の場合、開始時点で暗号に必要な鍵が確定しているため、最初のメッセージに暗号化したデータを含めて送信することが可能になっている。
ただし、その場合前方秘匿性 (PFS) が失われる点に注意。

## 参考リンク

- [TLS 1.3の性能 その3 - 事前共有鍵（Pre-Shared Key: PSK） - wolfSSL](https://www.wolfssl.jp/wolfblog/2018/06/04/tls-1-3performance3/)
