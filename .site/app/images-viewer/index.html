<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Images Viewer</title>
  <style>
    :root {
      --footer-height: 48px;
      --content-height: calc(100% - var(--footer-height));
    }

    #viewer-area {
      background-color: #000;
      height: 100vh;
      position: absolute;
      width: 100vw;
    }

    .content-wrapper {
      align-items: center;
      display: flex;
      height: var(--content-height);
      position: relative;
      width: 100%;
    }

    #images-wrapper {
      height: 100%;
      width: 100%;
    }

    .image-wrapper {
      height: 100%;
      overflow: hidden;
    }

    .image {
      height: 100%;
      object-fit: contain;
      width: 100%;
    }

    #left-image-wrapper {
      bottom: 0;
      right: 50%;
      position: absolute;
      text-align: right;
      top: 0;
      max-width: 50%;
    }

    #right-image-wrapper {
      bottom: 0;
      position: absolute;
      left: 50%;
      text-align: left;
      top: 0;
      max-width: 50%;
    }

    .footer-area {
      border-top: 1px solid #999;
      box-sizing: border-box;
      display: flex;
      height: var(--footer-height);
      justify-content: center;
      overflow-x: scroll;
      overflow-y: hidden;
    }

    .footer {
      align-items: center;
      color: #fff;
      display: flex;
      height: 40px;
      padding: 4px;
    }

    .show-0-images {
      display: none;
    }

    .show-1-images #left-image-wrapper {
      max-width: 0;
    }

    .show-1-images #right-image-wrapper {
      left: 0;
      max-width: 100%;
      right: 0;
      text-align: center;
    }

    .show-1-images #next-one-button {
      display: none;
    }
  </style>
</head>
<body style="position: relative; width: 100vw; height: 100vh; overflow: hidden; margin: 0; background-color: #333;">
  <input
    id="file-selector"
    type="file"
    accept="text/plain,application/zip"
    style="position: fixed; bottom: -1px; left: -1px; max-width: 1px; max-height: 1px; overflow: hidden;"
  >
  <div
    id="file-drop-area"
    style="position: absolute; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center;"
  >
    <div style="color: #fff;">
      Drop zip / list (text) file here or
      <button
        id="select-video-file"
        style="font-size: 1rem; color: #fff; background: none; border: none; padding: 0; margin: 0; text-decoration: underline; cursor: pointer;"
      >
        select file.
      </button>
    </div>
  </div>
  <div id="viewer-area" class="show-0-images">
    <div class="content-wrapper">
      <div id="images-wrapper">
        <div id="left-image-wrapper" class="image-wrapper">
          <img id="left-image" class="image" src="" alt="Left image">
        </div>
        <div id="right-image-wrapper" class="image-wrapper">
          <img id="right-image" class="image" src="" alt="Right image">
        </div>
      </div>
    </div>
    <div class="footer-area">
      <div class="footer">
        <button
          id="next-one-button"
          style="height: 40px; box-sizing: border-box; padding: 0 8px; line-height: 40px; background: none; border: none; color: #fff; text-decoration: underline;"
        >
          +1
        </button>
        <button
          id="next-button"
          style="height: 40px; box-sizing: border-box; padding: 0 16px; line-height: 40px; margin-right: 16px;"
        >
          Next
        </button>
        [&nbsp;
        <div id="current-page-number">1</div>
        <div style="margin: 0 8px;">/</div>
        <div id="max-page-number">1</div>
        &nbsp;]
        <button
          id="toggle-page-num-button"
          style="height: 40px; box-sizing: border-box; padding: 0 8px; line-height: 40px; background: none; border: none; color: #fff; text-decoration: underline;"
        >
          1P
        </button>
        <button
          id="prev-button"
          style="height: 40px; box-sizing: border-box; padding: 0 16px; line-height: 40px; margin-left: 16px;"
        >
          Prev
        </button>
      </div>
    </div>
  </div>
  <div id="loading"
       style="display: none; background-color: #000; color: #fff; height: 100vh; position: absolute; width: 100vw; align-items: center; justify-content: center;">
    <div style="font-size: 2rem; font-weight: bold;">LOADING...</div>
  </div>

  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", () => {
      const fileSelectorElement = document.getElementById("file-selector");
      document.getElementById("select-video-file").onclick = () => fileSelectorElement.click();
      const fileDropAreaElement = document.getElementById("file-drop-area");

      const images = new Images();
      const addImageUrl = (imageUrl) => images.addImageUrl(imageUrl);
      loadByQueryParams(addImageUrl);
      setFileHandling(fileSelectorElement, fileDropAreaElement, addImageUrl);
    });
  </script>

  <script type="text/javascript">
    class Images {
      constructor() {
        const nextButtonElement = document.getElementById("next-button");
        const nextOneButtonElement = document.getElementById("next-one-button");
        const togglePageNumButtonElement = document.getElementById("toggle-page-num-button");
        const prevButtonElement = document.getElementById("prev-button");

        const viewerAreaElement = document.getElementById("viewer-area");
        this.showViewerArea = (num) => {
          this.showPageNum = num;
          viewerAreaElement.classList.remove(Array.from(viewerAreaElement.classList.entries()).map(([_, e]) => e));
          viewerAreaElement.classList.add(`show-${Util.getNumInRange(0, num, 2)}-images`);
          togglePageNumButtonElement.innerText = `${num}P`;
          const url = new URL(window.location.href);
          url.searchParams.set("page", num);
          window.history.replaceState(null, "", url.toString());
        };
        this.showPageNum = parseInt(new URL(window.location.href).searchParams.get("page"), 10) || matchMedia("(orientation: portrait)").matches ? 1 : 2;

        this.maxPageNumberElement = document.getElementById("max-page-number");
        this.currentPageNumberElement = document.getElementById("current-page-number");

        const imagesWrapperElement = document.getElementById("images-wrapper");
        const leftImageElement = document.getElementById("left-image");
        const rightImageElement = document.getElementById("right-image");

        this.currentImageIndex = 0;
        this.imageUrls = [];

        this.setCurrentImageIndex = (index) => {
          this.currentImageIndex = Util.getNumInRange(0, index, this.imageUrls.length - this.showPageNum);
          this.currentPageNumberElement.innerText = this.currentImageIndex + 1;
          if (rightImageElement.src !== this.imageUrls[this.currentImageIndex]) {
            rightImageElement.src = this.imageUrls[this.currentImageIndex] || "";
          }
          if (leftImageElement.src !== this.imageUrls[this.currentImageIndex + 1]) {
            leftImageElement.src = this.imageUrls[this.currentImageIndex + 1] || "";
          }
        };
        this.addCurrentImageIndex = (add) => {
          this.setCurrentImageIndex(this.currentImageIndex + add);
        };
        leftImageElement.addEventListener("click", () => this.addCurrentImageIndex(this.showPageNum));
        rightImageElement.addEventListener("click", () => this.addCurrentImageIndex(this.showPageNum === 2 ? -2 : 1));

        nextOneButtonElement.addEventListener("click", () => this.addCurrentImageIndex(1));
        togglePageNumButtonElement.addEventListener("click", () => {
          this.showPageNum = this.showPageNum === 2 ? 1 : 2;
          this.showViewerArea(this.showPageNum);
        });
        nextButtonElement.addEventListener("click", () => this.addCurrentImageIndex(this.showPageNum));
        prevButtonElement.addEventListener("click", () => this.addCurrentImageIndex(this.showPageNum * -1));

        window.addEventListener("keydown", (event) => {
          const { key } = event;
          switch (key) {
            case "f":
              event.preventDefault();
              if (document.fullscreenElement == null) {
                imagesWrapperElement.requestFullscreen().catch(console.error);
              } else {
                document.exitFullscreen().catch(console.error);
              }
              break;
            case " ":
              event.preventDefault();
              this.showViewerArea(this.showPageNum === 2 ? 1 : 2);
              break;
            case "ArrowLeft":
              event.preventDefault();
              this.addCurrentImageIndex(this.showPageNum);
              break;
            case "ArrowRight":
              event.preventDefault();
              this.addCurrentImageIndex(this.showPageNum * -1);
              break;
            case "ArrowUp":
              event.preventDefault();
              this.addCurrentImageIndex(-1);
              break;
            case "ArrowDown":
              event.preventDefault();
              this.addCurrentImageIndex(1);
              break;
            case "0":
            case "1":
            case "2":
            case "3":
            case "4":
            case "5":
            case "6":
            case "7":
            case "8":
            case "9":
              event.preventDefault();
              this.setCurrentImageIndex(Math.round(this.imageUrls.length * parseInt(key, 10) * 0.1));
              return;
          }
        });
      }

      addImageUrl(imageUrl) {
        this.imageUrls.push(imageUrl);
        this.maxPageNumberElement.innerText = this.imageUrls.length;
        if (imageUrl.length > 0) {
          this.showViewerArea(this.showPageNum);
        }
        this.addCurrentImageIndex(0);
      };
    }
  </script>

  <script type="text/javascript">
    const setFileHandling = (fileSelectorElement, fileDropAreaElement, callback) => {
      const onFileSelected = async (file) => {
        if (file != null) {
          if (file.type === ("application/zip")) {
            await parseZip(await file.arrayBuffer(), callback);
          } else if (file.type === ("text/plain")) {
            parseTextList(await file.text(), callback);
          }
        }
      };
      fileSelectorElement.addEventListener("change", (event) => {
        event.preventDefault();
        event.stopPropagation();
        onFileSelected(fileSelectorElement.files[0]);
      });
      fileDropAreaElement.addEventListener("dragover", (event) => {
        event.stopPropagation();
        event.preventDefault();
      });
      fileDropAreaElement.addEventListener("drop", (event) => {
        event.preventDefault();
        event.stopPropagation();
        onFileSelected(event.dataTransfer.files[0]);
      });
    };
  </script>

  <script type="text/javascript">
    const loadByQueryParams = async (callback) => {
      const showLoading = (loading) => document.getElementById("loading").style.display = loading ? "flex" : "none";
      try {
        showLoading(true);
        const { searchParams } = new URL(window.location.href);
        const zipUrl = searchParams.get("zip_url");
        const listUrl = searchParams.get("list_url");
        if (zipUrl != null && zipUrl.startsWith("https://")) {
          const zipResponse = await fetch(zipUrl);
          await parseZip(await zipResponse.arrayBuffer(), callback);
        } else if (listUrl != null && listUrl.startsWith("https://")) {
          const listResponse = await fetch(listUrl);
          parseTextList(await listResponse.text(), callback);
        }
      } catch (err) {
        alert(`ERROR: ${err}`);
      } finally {
        showLoading(false);
      }
    };
  </script>

  <script src="./jszip.min.js"></script>
  <script type="text/javascript">
    const parseZip = async (arrayBuffer, callback) => {
      const zip = new JSZip();
      const zipData = await zip.loadAsync(arrayBuffer);
      const files = zipData.files;
      const names = Object.keys(files);
      names.sort();
      for await (const name of names) {
        // https://news.mynavi.jp/article/osxhack-30/
        if (name.startsWith("__MACOSX/")) {
          continue;
        }
        const [...ns] = name.toLowerCase().split(".");
        if (!["jpg", "jpeg", "png", "avif"].includes(ns[ns.length - 1])) {
          continue;
        }
        const data = files[name];
        const blob = await data.async("blob");
        const url = URL.createObjectURL(blob);
        callback(url);
      }
    };
  </script>

  <script type="text/javascript">
    const parseTextList = (text, callback) => {
      text.trim()
        .split(new RegExp("\r?\n"))
        .map((line) => line.trim())
        .filter((line) => line.startsWith("https://"))
        .forEach((url) => callback(url));
    };
  </script>

  <script type="text/javascript">
    const Util = {
      isPortrait: () => matchMedia("(orientation: portrait)").matches,
      getNumInRange: (min, target, max) => Math.min(Math.max(min, target), max)
    };
  </script>
</body>
</html>
