---
title: なぜリフレッシュトークンを使うのか？
---

## 目的

OAuth2 で使われるリフレッシュトークンですが、なぜこれを使うのかの理解が十分ではなかったことに気づいたのでまとめました。

## アクセストークンとは？

アクセストークンは、保護されたリソースにアクセスするためにアクセス可能であるか判断するためのトークンです。
アクセストークンの有効期限は短く設定されている場合が多く（イメージとしては数十分〜数時間）、秘匿すべき情報ではありますが、流出した場合でも悪用に使用できる時間が短くなっているため、リスクは低くなっています。

## リフレッシュトークンとは？

リフレッシュトークンは、アクセストークンを発行するために使用するトークンです。
リフレッシュトークンは有効期限が長く設定され（イメージとしては数十日以上）、流出した場合のリスクが大きいので、厳重に管理する必要があります。

ちなみに OAuth 的に発行は任意であるため、発行されない場合もあります。

## アクセストークンとリフレッシュトークンに求められるセキュリティの違い

> Access Tokenは秘密にしなければなりませんが、存続期間が短いため、セキュリティの考慮事項の制限も緩くなります。
>
> https://auth0.com/blog/jp-refresh-tokens-what-are-they-and-when-to-use-them/

アクセストークンは、リフレッシュトークンと比較すると求められるセキュリティレベルは低くなります。ただし、あくまで比較すればの話であって、アクセストークンも秘匿しなければならない情報であることには代わりありません。

## リフレッシュトークンの安全性

先に説明した通り、リフレッシュトークンはアクセストークンを発行するためだけに使われるトークンです。
その性質上、クライアント（アプリケーションサーバーなど）と認可サーバーとの間でのみやりとりされます。リソースサーバーなど他のサーバーに送られることがないため、攻撃を受ける部分を最小化することができます。

## アクセストークンとJWT

JWT は "JSON Web Token" の略称で、トークンの形式の一種です。（詳細を知りたい方は、私が書いた [JWTについてまとめてみる](https://zenn.dev/mryhryki/articles/2021-03-28-json-web-token) などを参考にしてみてください）
その特性の一つとして、トークン自体に有効期限などの情報を含めることができ、更に署名（JWS）により確かに発行者が指定したものであることが保証できます。また、事前共有鍵や公開鍵暗号を使用して署名の検証ができるので、API やデータベースへの問い合わせが不要です。
これはサービスのスケーリングの観点で大きなメリットです。そのため、アクセストークンとJWTは相性が良いです。

ただし、API やデータベースへの問い合わせを行わないため無効化することができず、流出した場合に対処することが実質できません。
そのため、有効期限を短くすることで、流出した場合のリスクを最小限にする、という方法が取られています。

## まとめ

アクセストークンとリフレッシュトークンの両方を使う理由は、セキュリティと利便性のバランスと取れるケースがあるから、と個人的には感じています。


## 関連リンク

- [Refresh Token： どのような場合に使用し、どのように JWT と相互作用するか](https://auth0.com/blog/jp-refresh-tokens-what-are-they-and-when-to-use-them/)
- [security - Why Does OAuth v2 Have Both Access and Refresh Tokens? - Stack Overflow](https://stackoverflow.com/questions/3487991)
